# Стартовые скрипты для использования tcpdump как сервиса.

### Установка:
1. Для корректной работы необходимо наличие установленных пакетов
    **bzip2, lsof, tcpdump**
2. Скопировать **tcpdump-as-service_3.9-1_all.deb** на сервер 

3. Установить пакет. Для этого выполнить команду 
    ```sh 
    dpgk –i tcpdump-as-service_3.9-1_all.deb
    ```
    находясь в том каталоге, куда пакет скопирован на шаге 2 
    
4. Пакет устанавливает следующие файлы 
    ```sh
    /etc/init.d/tcpdump_any
    /etc/init.d/tcpdump_bond0 
    /etc/init.d/tcpdump_eth0 
    /etc/init.d/tcpdump_eth1 
    /etc/init.d/tcpdump_eth2
    /etc/tcpdump.d/tcpdump_any
    /etc/tcpdump.d/tcpdump_bond0
    /etc/tcpdump.d/tcpdump_eth1
    /etc/tcpdump.d/tcpdump_eth0
    /etc/tcpdump.d/tcpdump_eth2
    /etc/tcpdump.d/archive_tcpdump.cfg 
    /usr/local/sbin/archive_tcpdump.sh 
    /usr/local/bin/sctpdechunk 
    ```
    Следующие файлы не будут установлены, если они уже имеются в системе: 
    ```sh
    /etc/tcpdump.d/tcpdump_any
    /etc/tcpdump.d/tcpdump_bond0
    /etc/tcpdump.d/tcpdump_eth1
    /etc/tcpdump.d/tcpdump_eth0
    /etc/tcpdump.d/tcpdump_eth2 
    /etc/tcpdump.d/archive_tcpdump.cfg
    ```
После установки пакета необходимо выполнить ещё несколько настроек. 

5. если на сервере достаточно памяти, то создаём рам-диск 
Посмотреть объем реальной свободной памяти можно так: 
    ```sh    
    free -m | awk 'NR==3 {print $4 " MB"}'  
    ```
    добавить соответствующую строку в **/etc/fstab**, например none 
    ```sh
        /var/tcpdump tmpfs size=8G 0 0 
    ```
    размер **size** зависит от количества свободной памяти, интенсивности траффика, частоты запуска архивации после этого выполнить команду 
    ```sh
    mount /var/tcpdump
    ```
6. В поставляемом архиве есть шаблоны для трёх служб для интерфейсов **eth1**, **eth2**, **eth0**, **bond0** и для псевдоинтерфейса **any**. Если на сервере сетевые интерфейсы называются как-то по-другому, то целесообразно создать новый файл для него и поменять параметры в нём и/или соответствующем файле в каталоге /etc/tcpdump.d.
    Параметры заданные в файлах в папке /etc/init.d переопределяются/дублируются в соответствующих файлах в папке /etc/tcpdump.d.
    **Любые изменения параметров лучше вносить в файл в папке /etc/tcpdump.d - там они не будут затёрты при обновлении пакета.**
    ```sh
    tcpdump_ethX 
    ```
    например 
    ```sh
    DAEMON_ARGS="-i eth0 -w /var/tcpdump/dump_eth0_ -s 0 -C 100 -W 200" 
    ```
    **-i eth0** - интерфейс 
    
    **-C** - размер одного дампа в мегабайтах 

    ***-W*** - количество дампов перезаписываемое по кругу (200*100=20гигабайт, но до такого не дойдёт, так как файлы архивируются).     

    **dump_eth0_** - имя несжатых дампов. Для работы скрипта архивации должно начинаться с dump, для удобства дальнейшей работы пусть содержит имя интерфейса и завершающее подчёркивание. Должно быть разным у разных сервисов. 
    
    Примеры параметров: 
    ```sh
    DAEMON_ARGS="-i eth1 -w /var/tcpdump/dump_eth1_ -s 0 -C 100 -W 200" 
    ```
    Такие параметры используются с серверами, где **eth1** – это внешний интерфейс.
    ```sh 
    DAEMON_ARGS="-i eth1 -w /var/tcpdump/dump_eth1_ -s 0 -C 100 -W 200 not tcp port22" 
    ```
    Такие параметры используются там, где надо прослушивать интерфейс eth1, но не записывать пакеты идущие на 22й порт и исходящие из 22го порта (sftp, ssh). 
        
    ```sh
    DAEMON_ARGS="-i eth2 -w /var/tcpdump/dump_eth2_ -s 0 -C 1 -W 200" 
    ```
    **-C 1** – используется для уменьшения размера дамп-файлов

7. добавить в планировщик кронтаб вызов скрипта архивации несжатых дампов из папки 
    ```sh
    /var/tcpdump/
    ``` 
    в папку 
    ```sh
    /var/tcpdumparc/
    ```
    Выполнить редактирование 
    ```sh
    crontab EDITOR=nano crontab -e 
    ```
    и добавить в конец строку 
    ```sh
    */5 * * * * /usr/local/sbin/archive_tcpdump.sh 
    ```
    или 
    ```sh
    */5 * * * * /usr/local/sbin/archive_tcpdump.sh >> /var/log/archive_tcpdump.log 2>&1 
    ```
    Если необходимо логгирование.
    Сохранить файл. Проверить командой 
    ```sh 
    crontab -l
    ```
    При архивации файл дампа переименуется в формат **ИмясервераДатапоследнегоизменениядампаИмядампаизнастроек_последоовательность.pcap** имя дампа из настроек – задаётся в пункте 6 в параметре **–w**.

8. запустить "сервис" 
    ```sh
    service tcpdump_eth0 start
    ```
9. Если есть необходимость запуска сервиса при загрузке сервера, то надо выполнить команду 
    ```sh
    update-rc.d tcpdump_eth0 defaults
    ```
10. Настройки Времени хранения архивов задаётся в файле 
    ```sh
    /etc/tcpdump.d/archive_tcpdump.cfg
    ```
    Параметр **OLDERMIN** - значение задаётся в минутах с предшествующим знаком "+", как этого требует формат команды **find**. Также в этом параметре есть настройка **SERVERSPEC**. Она отвечает за обработку дампов перед сжатием.
    
    **SERVERSPEC='EDP'** - Дампы никак не обрабатываются. Походит для серверов всех типов.
    **SERVERSPEC='RESK'** - Дамп обрабатывается программой /usr/local/bin/sctpdechunk, в архиве сохраняются оригинальный и обработанный файл
    **SERVERSPEC='RESD'** - Дамп обрабатывается программой /usr/loacl/bin/sctpdechunk, в архиве сохраняется только обработанный файл
    Программе 
    ```sh
    /usr/local/bin/sctpdechunk
    ```
    для работы требуется установленный интерпретатор **perl** (по умолчанию есть на многих серверах)

### Итого
несжатые дампы будут писаться в папку 

        /var/tcpdump/ 
Архиватор каждые 5 минут будет перемещать их в архивы в папке /var/tcpdumparc/

